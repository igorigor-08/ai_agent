<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–∏–∞–ª–æ–≥ —Å –±–æ—Ç–æ–º</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <style>
        /* –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
            border-radius: 8px;
            overflow: hidden;
        }

        .data-table th,
        .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .data-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .data-table tr:hover {
            background-color: #f5f5f5;
        }

        .table-container {
            max-width: 100%;
            overflow-x: auto;
            margin: 1rem 0;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <h1>–î–∏–∞–ª–æ–≥ —Å –±–æ—Ç–æ–º</h1>
        <div id="chat-box">
            {% for message in chat_history %}
                <div class="chat-message user-message">
                    <div class="avatar user-avatar">
                        üë§
                    </div>
                    <div class="message-content">
                        <div class="user-request">
                            <p>{{ message.user }}</p>
                        </div>
                    </div>
                </div>
                <div class="chat-message {% if message.bot %}bot-message{% else %}user-message{% endif %}">
                    <div class="avatar {% if message.bot %}bot-avatar{% else %}user-avatar{% endif %}">
                        {% if message.bot %}ü§ñ{% else %}üë§{% endif %}
                    </div>
                    <div class="message-content">
                        {% if message.bot %}
                            <div class="bot-response">
                                {% if message.bot.text %}
                                    <p>{{ message.bot.text }}</p>
                                {% endif %}
                                {% if message.bot.table %}
                                    <div class="table-container">
                                        {{ message.bot.table|safe }}
                                    </div>
                                {% endif %}
                                {% if message.bot.image %}
                                    <img src="{{ url_for('uploaded_file', filename=message.bot.image) }}" 
                                         alt="–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö">
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>
        <form id="chat-form">
            <input type="text" id="user-input" name="message" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." required>
            <button type="submit">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-send"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                <span>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</span>
            </button>
        </form>
    </div>
    <script>
        document.getElementById('chat-form').addEventListener('submit', function(event) {
            event.preventDefault();
            const userInput = document.getElementById('user-input');
            const message = userInput.value;
            
            fetch('/send_message', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `message=${encodeURIComponent(message)}`
            })
            .then(response => response.json())
            .then(data => {
                const chatBox = document.getElementById('chat-box');
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                addMessage({
                    isBot: false,
                    text: data.user_message,
                    image: null
                });
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –±–æ—Ç–∞
                addMessage({
                    isBot: true,
                    text: data.bot_response.text,
                    table: data.bot_response.table,
                    image: data.bot_response.image
                });
                
                userInput.value = '';
                chatBox.scrollTop = chatBox.scrollHeight;
            });
        });
        
        function addMessage({isBot, text, table, image}) {
            const chatBox = document.getElementById('chat-box');
            
            // –°–æ–∑–¥–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${isBot ? 'bot-message' : 'user-message'}`;
            
            // –°–æ–∑–¥–∞–µ–º –∞–≤–∞—Ç–∞—Ä
            const avatar = document.createElement('div');
            avatar.className = `avatar ${isBot ? 'bot-avatar' : 'user-avatar'}`;
            avatar.textContent = isBot ? 'ü§ñ' : 'üë§';
            
            // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –µ—Å–ª–∏ –µ—Å—Ç—å
            if (text) {
                const textPara = document.createElement('p');
                textPara.textContent = text;
                contentDiv.appendChild(textPara);
            }

            if (table) {
                const tableContainer = document.createElement('div');
                tableContainer.className = 'table-container';
                tableContainer.innerHTML = table;
                contentDiv.appendChild(tableContainer);
            }

            // –î–æ–±–∞–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –µ—Å–ª–∏ –µ—Å—Ç—å
            if (image) {
                const img = document.createElement('img');
                img.src = `/static/images/${image}`;
                img.alt = "–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö";
                img.style.maxWidth = '100%';
                img.style.height = 'auto';
                img.style.borderRadius = '12px';
                img.style.marginTop = '10px';
                img.style.boxShadow = '0 4px 6px rgba(0, 0, 0, 0.1)';
                contentDiv.appendChild(img);
            }
            
            // –°–æ–±–∏—Ä–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –≤–º–µ—Å—Ç–µ
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);
            
            // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
            messageDiv.style.opacity = '0';
            messageDiv.style.transform = 'translateY(10px)';
            chatBox.appendChild(messageDiv);
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
            setTimeout(() => {
                messageDiv.style.opacity = '1';
                messageDiv.style.transform = 'translateY(0)';
            }, 50);
        }
        </script>
</body>
</html>